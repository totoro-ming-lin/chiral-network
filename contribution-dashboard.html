<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chiral Network - Contribution Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --purple: #a855f7;
      --pink: #ec4899;
      --cyan: #06b6d4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--bg-card);
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent-light), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--accent-light);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section {
      margin-bottom: 3rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section h2 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--accent);
      color: white;
    }

    .tab:hover:not(.active) {
      background: var(--bg-card);
    }

    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }

    .chart-container-small {
      position: relative;
      height: 300px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
    }

    /* Team Rankings Table */
    .rankings-table {
      width: 100%;
      border-collapse: collapse;
    }

    .rankings-table th,
    .rankings-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--bg-card);
    }

    .rankings-table th {
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .rankings-table th.sortable {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }

    .rankings-table th.sortable:hover {
      color: var(--accent-light);
    }

    .rankings-table th.sortable.active {
      color: var(--accent-light);
    }

    .rankings-table tbody tr:hover {
      background: var(--bg-card);
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1e293b; }
    .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #1e293b; }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #1e293b; }
    .rank-other { background: var(--bg-card); color: var(--text-secondary); }

    .team-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .team-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: capitalize;
    }

    .team-turtle { background: #22c55e33; color: #22c55e; }
    .team-potato { background: #f59e0b33; color: #f59e0b; }
    .team-pandas { background: #ef444433; color: #ef4444; }
    .team-iris { background: #a855f733; color: #a855f7; }
    .team-eagles { background: #3b82f633; color: #3b82f6; }
    .team-orca { background: #06b6d433; color: #06b6d4; }
    .team-hawks { background: #ec489933; color: #ec4899; }
    .team-totoro { background: #8b5cf633; color: #8b5cf6; }
    .team-walrus { background: #14b8a633; color: #14b8a6; }
    .team-cactus { background: #84cc1633; color: #84cc16; }
    .team-whales { background: #0ea5e933; color: #0ea5e9; }
    .team-staff { background: #64748b33; color: #94a3b8; }
    .team-external { background: #64748b33; color: #64748b; }
    .team-unknown { background: #64748b33; color: #64748b; }

    .score {
      font-weight: 600;
      color: var(--success);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
      width: 120px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .type-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .type-critical { background: linear-gradient(135deg, #fbbf2433, #f59e0b33); color: #fbbf24; font-weight: 600; border: 1px solid #fbbf2455; }
    .type-feature { background: #22c55e33; color: #22c55e; }
    .type-bugfix { background: #ef444433; color: #ef4444; }
    .type-ui { background: #a855f733; color: #a855f7; }
    .type-network { background: #3b82f633; color: #3b82f6; }
    .type-docs { background: #64748b33; color: #94a3b8; }
    .type-test { background: #f59e0b33; color: #f59e0b; }
    .type-refactor { background: #06b6d433; color: #06b6d4; }
    .type-security { background: #ec489933; color: #ec4899; }
    .type-blockchain { background: #8b5cf633; color: #8b5cf6; }
    .type-performance { background: #14b8a633; color: #14b8a6; }
    .type-chore { background: #64748b33; color: #64748b; }
    .type-other { background: #64748b33; color: #64748b; }

    .team-summary-title {
      text-transform: capitalize;
      color: var(--accent-light);
    }

    .team-summary-text {
      line-height: 1.8;
      color: var(--text-secondary);
      font-size: 0.95rem;
      text-align: justify;
    }

    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .filter-bar input,
    .filter-bar select {
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: 1px solid var(--bg-card);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .filter-bar input::placeholder {
      color: var(--text-secondary);
    }

    .filter-bar input:focus,
    .filter-bar select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .member-card {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      transition: transform 0.2s;
    }

    .member-card:hover {
      transform: translateX(4px);
    }

    .member-info h4 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .member-info p {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .member-stats {
      display: flex;
      gap: 1.5rem;
      text-align: right;
    }

    .member-stats span {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .member-stats strong {
      display: block;
      color: var(--text-primary);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .pagination button {
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border: none;
      border-radius: 4px;
      color: var(--text-primary);
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: var(--accent);
    }

    footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
      border-top: 1px solid var(--bg-card);
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      header h1 {
        font-size: 1.75rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
      }

      .rankings-table {
        font-size: 0.85rem;
      }

      .rankings-table th,
      .rankings-table td {
        padding: 0.75rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Chiral Network Contribution Dashboard</h1>
      <p>Class Project Contribution Analysis - Team and Individual Rankings</p>
      <p id="date-range" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
    </header>

    <!-- Summary Stats -->
    <div class="stats-grid" id="summary-stats">
      <div class="stat-card">
        <div class="stat-value" id="total-commits">-</div>
        <div class="stat-label">Total Commits</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-teams">-</div>
        <div class="stat-label">Teams</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-members">-</div>
        <div class="stat-label">Contributors</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-features">-</div>
        <div class="stat-label">Features</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-bugfixes">-</div>
        <div class="stat-label">Bug Fixes</div>
      </div>
    </div>

    <!-- Contribution Over Time -->
    <div class="section">
      <div class="section-header">
        <h2>Contribution Timeline</h2>
        <div class="tabs" id="timeline-tabs">
          <button class="tab active" onclick="selectTimelineTeam('')">All Teams</button>
        </div>
      </div>
      <div class="card">
        <div class="chart-container">
          <canvas id="timeline-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid-2 section">
      <div class="card">
        <h3 style="margin-bottom: 1rem;">Contribution Types</h3>
        <div class="chart-container-small">
          <canvas id="types-chart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom: 1rem;">Team Commits Distribution</h3>
        <div class="chart-container-small">
          <canvas id="team-pie-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Team Rankings -->
    <div class="section">
      <div class="section-header">
        <h2>Team Rankings</h2>
      </div>
      <div class="card">
        <table class="rankings-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th>Members</th>
              <th>Commits</th>
              <th>Lines Added</th>
              <th>Score</th>
              <th>Activity</th>
            </tr>
          </thead>
          <tbody id="team-rankings">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Individual Rankings -->
    <div class="section">
      <div class="section-header">
        <h2>Individual Contributors</h2>
      </div>
      <div class="card">
        <div class="filter-bar">
          <input type="text" id="search-member" placeholder="Search by name...">
          <select id="filter-team">
            <option value="">All Teams</option>
          </select>
          <select id="filter-type">
            <option value="">All Types</option>
            <option value="critical">Critical (Core Design)</option>
            <option value="feature">Feature</option>
            <option value="bugfix">Bug Fix</option>
            <option value="ui">UI</option>
            <option value="network">Network</option>
            <option value="docs">Documentation</option>
            <option value="test">Testing</option>
            <option value="security">Security</option>
            <option value="blockchain">Blockchain</option>
          </select>
          <select id="sort-by">
            <option value="score">Sort by Score</option>
            <option value="commits">Sort by Commits</option>
            <option value="additions">Sort by Lines Added</option>
          </select>
        </div>
        <div id="member-list"></div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <!-- Team Breakdown Charts -->
    <div class="section">
      <div class="section-header">
        <h2>Team Contribution Breakdown</h2>
        <div class="tabs" id="team-tabs"></div>
      </div>
      <div class="card">
        <div class="chart-container">
          <canvas id="team-breakdown-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Team Summary -->
    <div class="section">
      <div class="section-header">
        <h2>Team Summary: <span id="team-summary-name" class="team-summary-title"></span></h2>
      </div>
      <div class="card">
        <p id="team-summary-text" class="team-summary-text"></p>
      </div>
    </div>

    <!-- Post-Semester Contributions -->
    <div class="section" id="post-semester-section">
      <div class="section-header">
        <h2 style="background: linear-gradient(135deg, #22c55e, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Post-Semester Contributions</h2>
        <span style="color: var(--text-secondary); font-size: 0.9rem;">After December 2025</span>
      </div>

      <div class="stats-grid" id="post-semester-stats">
        <div class="stat-card" style="border: 1px solid #22c55e33;">
          <div class="stat-value" id="post-total-commits" style="color: #22c55e;">-</div>
          <div class="stat-label">Total Commits</div>
        </div>
        <div class="stat-card" style="border: 1px solid #06b6d433;">
          <div class="stat-value" id="post-total-contributors" style="color: #06b6d4;">-</div>
          <div class="stat-label">Active Contributors</div>
        </div>
        <div class="stat-card" style="border: 1px solid #a855f733;">
          <div class="stat-value" id="post-total-prs" style="color: #a855f7;">-</div>
          <div class="stat-label">Pull Requests</div>
        </div>
        <div class="stat-card" style="border: 1px solid #f59e0b33;">
          <div class="stat-value" id="post-date-range" style="color: #f59e0b; font-size: 1.2rem;">-</div>
          <div class="stat-label">Date Range</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1rem; color: #22c55e;">Post-Semester Contributors</h3>
        <div id="post-semester-contributors">
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Loading post-semester data...</p>
        </div>
      </div>
    </div>

    <footer>
      <p>Generated at <span id="generated-at">-</span></p>
      <p style="margin-top: 0.5rem;">Chiral Network Class Project Contribution Dashboard</p>
    </footer>
  </div>

  <script>
    let data = null;
    let filteredMembers = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    // Load data
    async function loadData() {
      try {
        const response = await fetch('contribution-data.json');
        data = await response.json();
        initDashboard();
      } catch (error) {
        console.error('Error loading data:', error);
        document.body.innerHTML = '<div style="padding: 2rem; text-align: center;">Error loading data. Make sure contribution-data.json exists.</div>';
      }
    }

    function initDashboard() {
      // Summary stats
      document.getElementById('total-commits').textContent = data.summary.totalCommits.toLocaleString();
      document.getElementById('total-teams').textContent = data.summary.totalTeams;
      document.getElementById('total-members').textContent = data.summary.totalMembers;
      document.getElementById('total-features').textContent = data.summary.typeBreakdown.feature || 0;
      document.getElementById('total-bugfixes').textContent = data.summary.typeBreakdown.bugfix || 0;
      document.getElementById('date-range').textContent = `${data.summary.dateRange.start} to ${data.summary.dateRange.end}`;
      document.getElementById('generated-at').textContent = new Date(data.generatedAt).toLocaleString();

      // Initialize charts
      initTimelineChart();
      initTypesChart();
      initTeamPieChart();
      initTeamRankings();
      initMemberList();
      initTeamBreakdown();

      // Event listeners
      document.getElementById('search-member').addEventListener('input', filterMembers);
      document.getElementById('filter-team').addEventListener('change', filterMembers);
      document.getElementById('filter-type').addEventListener('change', filterMembers);
      document.getElementById('sort-by').addEventListener('change', filterMembers);
    }

    let timelineChart = null;
    let selectedTimelineTeam = '';

    function initTimelineChart() {
      // Add team tabs
      const tabsContainer = document.getElementById('timeline-tabs');
      const teams = data.teams.filter(t => !['staff', 'external', 'unknown'].includes(t.name));

      tabsContainer.innerHTML = `
        <button class="tab active" onclick="selectTimelineTeam('')">All Teams</button>
        ${teams.map(t =>
          `<button class="tab" onclick="selectTimelineTeam('${t.name}')">${t.name}</button>`
        ).join('')}
      `;

      renderTimelineChart();
    }

    function selectTimelineTeam(teamName) {
      selectedTimelineTeam = teamName;
      document.querySelectorAll('#timeline-tabs .tab').forEach(tab => {
        const isAll = tab.textContent === 'All Teams';
        const isSelected = isAll ? teamName === '' : tab.textContent === teamName;
        tab.classList.toggle('active', isSelected);
      });
      renderTimelineChart();
    }

    function renderTimelineChart() {
      if (timelineChart) {
        timelineChart.destroy();
      }

      const ctx = document.getElementById('timeline-chart').getContext('2d');

      // Get timeline data based on selection
      let timeline;
      let chartLabel;
      let chartColor;

      if (selectedTimelineTeam === '') {
        // All teams
        timeline = data.summary.timeline;
        chartLabel = 'All Teams';
        chartColor = '#3b82f6';
      } else {
        // Specific team
        const team = data.teams.find(t => t.name === selectedTimelineTeam);
        if (team && team.timeline) {
          // Convert team timeline object to sorted array
          const allWeeks = data.summary.timeline.map(t => t[0]);
          timeline = allWeeks.map(week => [week, team.timeline[week] || 0]);
          chartLabel = selectedTimelineTeam.charAt(0).toUpperCase() + selectedTimelineTeam.slice(1);

          // Team-specific colors
          const teamColors = {
            turtle: '#22c55e', potato: '#f59e0b', pandas: '#ef4444',
            iris: '#a855f7', eagles: '#3b82f6', orca: '#06b6d4',
            hawks: '#ec4899', totoro: '#8b5cf6', walrus: '#14b8a6',
            cactus: '#84cc16', whales: '#0ea5e9'
          };
          chartColor = teamColors[selectedTimelineTeam] || '#3b82f6';
        } else {
          timeline = data.summary.timeline;
          chartLabel = 'All Teams';
          chartColor = '#3b82f6';
        }
      }

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeline.map(t => t[0]),
          datasets: [{
            label: chartLabel,
            data: timeline.map(t => t[1]),
            borderColor: chartColor,
            backgroundColor: chartColor + '20',
            fill: true,
            tension: 0.4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#94a3b8'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#334155'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#94a3b8',
                maxTicksLimit: 12
              }
            }
          }
        }
      });
    }

    function initTypesChart() {
      const ctx = document.getElementById('types-chart').getContext('2d');
      const types = Object.entries(data.summary.typeBreakdown)
        .filter(([type]) => type !== 'merge' && type !== 'other')
        .sort((a, b) => b[1] - a[1]);

      const colors = {
        critical: '#fbbf24',
        feature: '#22c55e',
        bugfix: '#ef4444',
        ui: '#a855f7',
        network: '#3b82f6',
        docs: '#94a3b8',
        test: '#f59e0b',
        refactor: '#06b6d4',
        security: '#ec4899',
        blockchain: '#8b5cf6',
        performance: '#14b8a6',
        chore: '#64748b',
      };

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: types.map(t => t[0].charAt(0).toUpperCase() + t[0].slice(1)),
          datasets: [{
            data: types.map(t => t[1]),
            backgroundColor: types.map(t => colors[t[0]] || '#64748b'),
            borderRadius: 4,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: '#334155'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          }
        }
      });
    }

    function initTeamPieChart() {
      const ctx = document.getElementById('team-pie-chart').getContext('2d');
      const teams = data.teams
        .filter(t => !['staff', 'external', 'unknown'].includes(t.name))
        .slice(0, 10);

      const colors = [
        '#22c55e', '#f59e0b', '#ef4444', '#a855f7', '#3b82f6',
        '#06b6d4', '#ec4899', '#8b5cf6', '#14b8a6', '#84cc16'
      ];

      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: teams.map(t => t.name.charAt(0).toUpperCase() + t.name.slice(1)),
          datasets: [{
            data: teams.map(t => t.commits),
            backgroundColor: colors,
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#94a3b8',
                padding: 15,
              }
            }
          }
        }
      });
    }

    function initTeamRankings() {
      const tbody = document.getElementById('team-rankings');
      const teams = data.teams.filter(t => !['staff', 'external', 'unknown'].includes(t.name));
      const maxScore = Math.max(...teams.map(t => t.score));

      tbody.innerHTML = teams.map((team, index) => `
        <tr>
          <td>
            <span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span>
          </td>
          <td>
            <span class="team-name">
              <span class="team-badge team-${team.name}">${team.name}</span>
            </span>
          </td>
          <td>${team.memberCount}</td>
          <td>${team.commits}</td>
          <td>${team.additions.toLocaleString()}</td>
          <td><span class="score">${team.score.toFixed(1)}</span></td>
          <td>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(team.score / maxScore * 100).toFixed(1)}%; background: linear-gradient(90deg, #3b82f6, #a855f7);"></div>
            </div>
          </td>
        </tr>
      `).join('');

      // Populate team filter
      const teamFilter = document.getElementById('filter-team');
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.name;
        option.textContent = team.name.charAt(0).toUpperCase() + team.name.slice(1);
        teamFilter.appendChild(option);
      });
    }

    function initMemberList() {
      filteredMembers = data.members.filter(m => !['staff', 'external', 'unknown'].includes(m.team));
      renderMemberList();
    }

    function filterMembers() {
      const search = document.getElementById('search-member').value.toLowerCase();
      const team = document.getElementById('filter-team').value;
      const type = document.getElementById('filter-type').value;
      const sortBy = document.getElementById('sort-by').value;

      filteredMembers = data.members
        .filter(m => !['staff', 'external', 'unknown'].includes(m.team))
        .filter(m => {
          if (search && !m.displayName.toLowerCase().includes(search)) return false;
          if (team && m.team !== team) return false;
          // Filter by anyone who has ANY commits of this type (not just primary)
          if (type && !(m.types[type] > 0)) return false;
          return true;
        })
        .sort((a, b) => {
          // When filtering by type, sort by that type's commit count
          if (type) {
            return (b.types[type] || 0) - (a.types[type] || 0);
          }
          if (sortBy === 'commits') return b.commits - a.commits;
          if (sortBy === 'additions') return b.additions - a.additions;
          return b.score - a.score;
        });

      currentPage = 1;
      renderMemberList();
    }

    function renderMemberList() {
      const container = document.getElementById('member-list');
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageMembers = filteredMembers.slice(start, end);
      const maxScore = Math.max(...data.members.map(m => m.score));
      const activeType = document.getElementById('filter-type').value;

      container.innerHTML = pageMembers.map((member, index) => {
        // Show filtered type count if a type filter is active
        const typeInfo = activeType
          ? `<span class="type-badge type-${activeType}">${member.types[activeType] || 0} ${activeType}</span>`
          : `<span class="type-badge type-${member.primaryType}">${member.primaryType}</span>`;

        return `
        <div class="member-card">
          <span class="rank-badge ${start + index < 3 ? 'rank-' + (start + index + 1) : 'rank-other'}">${start + index + 1}</span>
          <div class="member-info">
            <h4>${member.displayName} <span class="team-badge team-${member.team}">${member.team}</span></h4>
            <p>
              ${typeInfo}
              Team rank: #${member.teamRank}
            </p>
          </div>
          <div class="member-stats">
            <span>Commits<strong>${member.commits}</strong></span>
            <span>+Lines<strong>${member.additions.toLocaleString()}</strong></span>
            <span>Score<strong class="score">${member.score.toFixed(1)}</strong></span>
          </div>
        </div>
      `}).join('');

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
      const container = document.getElementById('pagination');

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = `
        <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
      `;

      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span style="color: var(--text-secondary);">...</span>';
        }
      }

      html += `
        <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
      `;

      container.innerHTML = html;
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderMemberList();
    }

    let teamBreakdownChart = null;
    let selectedTeam = null;

    function initTeamBreakdown() {
      const teams = data.teams.filter(t => !['staff', 'external', 'unknown'].includes(t.name));
      const tabsContainer = document.getElementById('team-tabs');

      tabsContainer.innerHTML = teams.map((team, i) => `
        <button class="tab ${i === 0 ? 'active' : ''}" onclick="selectTeam('${team.name}')">${team.name}</button>
      `).join('');

      selectedTeam = teams[0].name;
      renderTeamBreakdown();
    }

    function selectTeam(teamName) {
      selectedTeam = teamName;
      document.querySelectorAll('#team-tabs .tab').forEach(tab => {
        tab.classList.toggle('active', tab.textContent === teamName);
      });
      renderTeamBreakdown();
    }

    function renderTeamBreakdown() {
      const team = data.teams.find(t => t.name === selectedTeam);
      const teamMembers = data.members.filter(m => m.team === selectedTeam).sort((a, b) => b.score - a.score);

      if (teamBreakdownChart) {
        teamBreakdownChart.destroy();
      }

      const ctx = document.getElementById('team-breakdown-chart').getContext('2d');
      const colors = [
        '#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#a855f7',
        '#06b6d4', '#ec4899', '#8b5cf6', '#14b8a6', '#84cc16'
      ];

      teamBreakdownChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: teamMembers.map(m => m.displayName),
          datasets: [
            {
              label: 'Features',
              data: teamMembers.map(m => m.types.feature || 0),
              backgroundColor: '#22c55e',
            },
            {
              label: 'Bug Fixes',
              data: teamMembers.map(m => m.types.bugfix || 0),
              backgroundColor: '#ef4444',
            },
            {
              label: 'UI',
              data: teamMembers.map(m => m.types.ui || 0),
              backgroundColor: '#a855f7',
            },
            {
              label: 'Network',
              data: teamMembers.map(m => m.types.network || 0),
              backgroundColor: '#3b82f6',
            },
            {
              label: 'Other',
              data: teamMembers.map(m =>
                m.commits - (m.types.feature || 0) - (m.types.bugfix || 0) -
                (m.types.ui || 0) - (m.types.network || 0) - (m.types.merge || 0)
              ),
              backgroundColor: '#64748b',
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#94a3b8',
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: {
                color: '#334155'
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          }
        }
      });

      // Update team summary
      document.getElementById('team-summary-name').textContent = selectedTeam;
      document.getElementById('team-summary-text').textContent = team.summary || 'No summary available for this team.';
    }

    // Load post-semester data
    async function loadPostSemesterData() {
      try {
        const response = await fetch('contribution-data-post-semester.json');
        if (!response.ok) {
          throw new Error('Post-semester data not available');
        }
        const postData = await response.json();
        renderPostSemesterData(postData);
      } catch (error) {
        console.log('Post-semester data not yet generated:', error.message);
        document.getElementById('post-semester-contributors').innerHTML = `
          <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
            Post-semester data not yet generated.<br>
            <span style="font-size: 0.85rem;">Run <code style="background: var(--bg-card); padding: 0.25rem 0.5rem; border-radius: 4px;">scripts/generate-post-semester-data.sh</code> to generate.</span>
          </p>
        `;
        document.getElementById('post-total-commits').textContent = '-';
        document.getElementById('post-total-contributors').textContent = '-';
        document.getElementById('post-total-prs').textContent = '-';
        document.getElementById('post-date-range').textContent = 'N/A';
      }
    }

    function renderPostSemesterData(postData) {
      // Update stats
      document.getElementById('post-total-commits').textContent = postData.summary.totalCommits.toLocaleString();
      document.getElementById('post-total-contributors').textContent = postData.summary.totalContributors;
      document.getElementById('post-total-prs').textContent = postData.summary.totalPRs || 0;
      document.getElementById('post-date-range').textContent =
        `${postData.summary.dateRange.start} - ${postData.summary.dateRange.end}`;

      // Render contributors list
      const container = document.getElementById('post-semester-contributors');

      if (!postData.contributors || postData.contributors.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No post-semester contributions yet.</p>';
        return;
      }

      const contributors = postData.contributors.sort((a, b) => b.commits - a.commits);

      container.innerHTML = contributors.map((contributor, index) => `
        <div class="member-card" style="display: block; padding: 1.25rem;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
            <span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span>
            <div style="flex: 1;">
              <h4 style="margin: 0;">${contributor.name} ${contributor.team ? `<span class="team-badge team-${contributor.team}">${contributor.team}</span>` : ''}</h4>
              <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">
                ${contributor.lastCommitDate ? `Last active: ${contributor.lastCommitDate}` : ''}
              </p>
            </div>
            <div class="member-stats">
              <span>Commits<strong>${contributor.commits}</strong></span>
              <span>+Lines<strong>${(contributor.additions || 0).toLocaleString()}</strong></span>
            </div>
          </div>
          ${contributor.summary ? `
            <div style="background: var(--bg-primary); border-radius: 6px; padding: 1rem; margin-top: 0.5rem;">
              <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;">
                ${contributor.summary.split('\n\n').map(para =>
                  `<p style="margin: 0 0 0.75rem 0; text-align: justify;">${para}</p>`
                ).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // Load data on page load
    loadData();
    loadPostSemesterData();
  </script>
</body>
</html>
